<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>图文对构建与清洗系统</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>

<h1 style="font-family: SimSun, serif;">图文对构建与清洗系统</h1>

<!-- 1. 数据爬取模块 -->
<div class="section">
  <h3 style="font-family: SimSun, serif;">1. 数据爬取模块</h3>
  <form id="scraperForm" class="row gx-3 gy-2 align-items-end">
    <div class="col">
      <label for="urlInput" class="form-label mb-1" style="font-family: SimSun, serif;">输入爬取网址或关键词</label>
      <input type="text" class="form-control" id="urlInput" placeholder="如 https://example.com 或关键词" required  style="border-radius: 15px;"/>
    </div>
    <div class="col-auto">
      <label for="threadCount" class="form-label mb-1" style="font-family: SimSun, serif;margin-left: 12px;">线程数</label>
      <input type="number" id="threadCount" class="form-control" min="1" max="5" value="3" style="border-radius: 15px;"/>
    </div>
    <div class="col-auto align-self-end" id="startScraping">
      <button type="submit" class="btn btn-success mt-3" style="border-radius: 15px; font-family: SimSun, serif;">启动爬取</button>
    </div>
  </form>
  <div class="mt-3">
    <strong style="font-family: SimSun, serif;">爬取进度日志：</strong>
    <div id="scraperLog" class="log-box"></div>
    <button class="btn-clear-log btn-btn-primary-mt-3" data-target-log="scraperLog">清空爬取日志</button>
  </div>
</div>

<!-- 2. 文本清洗和图像预处理模块 -->
<div class="section">
  <h3 style="font-family: SimSun, serif;">2. 文本清洗模块和图像预处理模块</h3>
  <button id="startCleaning" class="btn btn-primary mt-3" style="border-radius: 15px;font-family: SimSun, serif;">开始文本清洗和图像预处理</button>
  <div>
    <strong style="font-family: SimSun, serif;">文本清洗日志：</strong>
    <div id="textCleanLog" class="log-box"></div>
    <button class="btn-clear-log btn-btn-primary-mt-3" data-target-log="textCleanLog">清空文本清洗日志</button>
  </div>
  <div>  
    <strong style="font-family: SimSun, serif;">图像预处理日志：</strong>
    <div id="imagePreprocessLog" class="log-box"></div>
    <button class="btn-clear-log btn-btn-primary-mt-3" data-target-log="imagePreprocessLog">清空图像预处理日志</button>
  </div>
</div>

<!-- 3. 数据导出模块 -->
<div class="section">
  <h3 style="font-family: SimSun, serif;">3. 数据导出模块</h3>
  <label for="exportFormat" class="form-label" style="font-family: SimSun, serif;">导出格式</label>
  <select id="exportFormat" class="form-select mb-3" style="max-width: 200px;border-radius: 0px;">
    <option value="jsonl" selected>JSONL</option>
    <option value="csv">CSV</option>
    <option value="parquet">Parquet</option>
  </select>
  <button id="exportDataBtn" class="btn btn-success" style="border-radius: 15px;font-family: SimSun, serif;">导出数据集</button>
  <button class="btn btn-secondary" onclick="downloadExportedDataset()" style="border-radius: 15px;">下载导出数据</button>
  <div class="mt-3">
    <strong style="font-family: SimSun, serif;">导出日志：</strong>
    <div id="exportLog" class="log-box"></div>
    <button class="btn-clear-log btn-btn-primary-mt-3" data-target-log="exportLog" >清空导出日志</button>
    <button class="btn-danger" onclick="deleteExportedFile()">删除导出文件</button>
  </div>
</div>

<script>
  //追加日志到指定日志容器，containerId 是日志框的id，text是要写入的文字
  function appendLog(containerId,text){
    const container = document.getElementById(containerId); // 找到对应日志区域
    if(!container) return; // 如果找不到，跳过
    const timestamp = new Date().toLocaleTimeString();
    container.textContent += `[${timestamp}] ${text}\n`; // 在已有文本后追加内容 + 换行符
    container.scrollTop = container.scrollHeight; // 滚动到底部，方便看最新日志
  };

  // 清空指定日志容器内容
  function clearLog(containerId){
    const container = document.getElementById(containerId); // 找到对应日志区域
    container.textContent = ''; // 清空文本内容
  };

  // 给所有清空日志按钮添加点击事件
  // 等页面DOM加载完成再做
  document.addEventListener('DOMContentLoaded',() => {
    // 选中所有class是btn-clear-log 的按钮
    const clearButtons = document.querySelectorAll('button.btn-clear-log');

    clearButtons.forEach(button => {
      // 给每个按钮绑定点击事件
      button.addEventListener('click',() => {
        const targetId = button.getAttribute('data-target-log'); // 获取按钮对应的日志框id
        if (!targetId) return;

        // 弹窗确认
        if (confirm('确定要清除此日志？')){
          clearLog(targetId); // 调用之前写好的清空函数
        }
      });
    });
  });

  // 模块1：“启动爬取”按钮实现
  document.getElementById('scraperForm').addEventListener('submit',(e) => {
    e.preventDefault();
    if (!confirm('确定开启爬虫任务？')) return;
    const url = document.getElementById('urlInput').value;
    const threads = document.getElementById('threadCount').value;
    const btn = document.getElementById('scraperForm');
    btn.disabled = true;
    appendLog('scraperLog','开始爬取数据：' + url + '，线程数：' + threads);
    fetch('/startScraping',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({'url':url,'threads':threads})})
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(data => {
      appendLog('scraperLog','爬取结束：' + data.message);
    })
    .catch(error => {
      appendLog('scraperLog','出现错误：' + error);
    })
    .finally(() => {
      btn.disabled=false;
    });
  });
  // 模块2：“文本清洗和图像预处理”按钮实现
  document.getElementById('startCleaning').addEventListener('click',() => {
    if (!confirm('确定进行文本清洗和图像预处理？')) return;
    const btn = document.getElementById('startCleaning');
    btn.disabled = true; 
    appendLog('textCleanLog','开始文本清洗......');
    appendLog('imagePreprocessLog','开始图像预处理......');
    fetch('/startCleaning',{method:'POST'})
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(data => {
      appendLog('textCleanLog','文本清洗结束：' + data.text_message);
      appendLog('imagePreprocessLog','图像预处理结束' + data.image_message);
    })
    .catch(error => {
      appendLog('textCleanLog','出现错误：' + error);
      appendLog('imagePreprocessLog','出现错误：' + error);
    })
    .finally(() => {
      btn.disabled = false;
    });
  });

    // 模块3：“导出数据集”按钮实现
  document.getElementById('exportDataBtn').addEventListener('click',() => {
    if (!confirm('确认导出当前处理后的数据集？')) return;
    const btn = document.getElementById('exportDataBtn');
    btn.disabled = true;
    const format = document.getElementById('exportFormat').value;
    appendLog('exportLog','开始导出当前处理后的数据集......');

    fetch('/exportData',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({'format':format})})
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(data => {
      appendLog('exportLog','数据集已导出：' + data.message);
    })
    .catch(error => {
      appendLog('exportLog','出现错误：' + error);
    })
    .finally(() => {
      btn.disabled = false;
    })
  });
  // 绑定模块3：删除导出文件按钮实现
  function deleteExportedFile() {
    if (!confirm('确定要删除导出文件？')) return;
    const btn = document.getElementById('exportDataBtn');
    btn.disabled = true;
    fetch('/deleteExportedDataset', { method: 'POST' })
    .then(response => response.json())
    .then(data => alert(data.message))
    .catch(error => alert('请求失败'))
    .finally(()=>{btn.disabled = false});
}
  function downloadExportedDataset() {
  fetch('/downloadExportedDataset')
    .then(response => {
      if (!response.ok) {
        throw new Error('文件下载失败');
      }
      return response.blob();
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cleaned_pairs.jsonl';
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    })
    .catch(error => {
      document.getElementById('exportLog').innerText = '[错误] 下载失败: ' + error.message;
    });
}

</script>

</body>

<style>
  body {
    padding: 20px;
    background-image: url("{{ url_for('static', filename='preview.jpg') }}"); /* 背景图路径 */
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    background-repeat: no-repeat;
    min-height: 100vh;
  }
  h1 {
    margin-bottom: 30px;
    text-align: center;
  }
  .section {
    background: rgba(255, 255, 255, 0.25);  /* 半透明白色背景 */
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
  }
  .log-box {
    height: 150px;
    overflow-y: auto;
    background: #e9ecef;
    background: rgba(233, 236, 239, 0.5);  /* 半透明日志背景 */
    border-radius: 20px;
    padding: 10px;
    font-family: monospace;
    white-space: pre-wrap;
  }
  .btn-clear-log{
    background-color: rgb(240, 95, 95);
    border-radius: 15px;
    font-family: SimSun, serif;
    margin-top: 15px;
    margin-bottom: 10px;
    color:#e9ecef;
    cursor: pointer;
    box-shadow: none;
    border-style: hidden;
  }
  .btn-clear-log:hover{
    background-color: red;
  }
  .btn-danger{
    background-color: rgb(0, 166, 255);
    border-radius: 15px;
    font-family: SimSun, serif;
    margin-top: 15px;
    margin-bottom: 10px;
    color:#e9ecef;
    cursor: pointer;
    box-shadow: none;
    border-style: hidden;
  }
  .btn-danger:hover{
    background-color: rgb(8, 0, 255);
  }
</style>

</html>
